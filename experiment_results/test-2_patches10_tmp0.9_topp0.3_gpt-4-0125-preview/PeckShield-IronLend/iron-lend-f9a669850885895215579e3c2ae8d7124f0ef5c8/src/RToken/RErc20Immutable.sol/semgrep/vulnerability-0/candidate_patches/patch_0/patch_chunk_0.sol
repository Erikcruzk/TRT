function doTransferOut(address payable to, uint amount) internal {
    EIP20NonStandardInterface token = EIP20NonStandardInterface(underlying);
    
    // Prevent re-entrancy attacks by updating state before external call
    uint balanceBefore = EIP20Interface(underlying).balanceOf(address(this));
    require(balanceBefore >= amount, "insufficient balance for transfer");
    balanceBefore -= amount; // Optimistically update balance

    token.transfer(to, amount);

    bool success;
    assembly {
        switch returndatasize()
            case 0 {                      
                success := not(0)          
            }
            case 32 {                     
                returndatacopy(0, 0, 32)
                success := mload(0)        
            }
            default {                     
                revert(0, 0)
            }
    }
    require(success, "TOKEN_TRANSFER_OUT_FAILED");

    // Re-validate balance after transfer to prevent re-entrancy and other token transfer violations
    uint balanceAfter = EIP20Interface(underlying).balanceOf(address(this));
    require(balanceAfter == balanceBefore, "balance mismatch after transfer");
}
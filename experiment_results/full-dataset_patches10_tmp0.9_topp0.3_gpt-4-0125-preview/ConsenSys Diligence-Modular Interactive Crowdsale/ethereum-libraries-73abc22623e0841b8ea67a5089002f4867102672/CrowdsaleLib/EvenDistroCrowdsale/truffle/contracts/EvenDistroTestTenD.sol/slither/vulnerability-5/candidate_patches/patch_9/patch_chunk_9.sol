function setTokens() public returns (bool) {
    require(msg.sender == sale.base.owner);
    require(!sale.base.tokensSet);
    require(now < sale.base.endTime);
    require(sale.numRegistered > 0); // Ensure there are registered users before setting tokens

    uint256 _tokenBalance = sale.base.token.balanceOf(this);
    sale.base.withdrawTokensMap[msg.sender] = _tokenBalance;
    sale.base.startingTokenBalance = _tokenBalance;
    sale.base.tokensSet = true;
    sale.calculateAddressTokenCap(); // Ensures the address token cap is recalculated based on the final number of registered users

    return true;
}
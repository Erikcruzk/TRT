function donate(address _donor, address _returnAddress, bytes32 checksum) payable only_during_period is_not_dust {
    
    if (!(sha3(bytes32(_donor)^bytes32(_returnAddress)) == checksum)) revert();

    
    var atoms = msg.value * atomRate;

    // calculate the number of atoms at the current rate and update the donor details first to prevent reentrancy
    record[_donor] += atoms;
    returnAddresses[_donor] = _returnAddress; 

    // update the totals
    totalEther += msg.value;
    totalAtom += atoms;

    // forward the funds to the treasurer safely avoiding reentrancy
    (bool success, ) = treasury.call.value(msg.value)("");
    require(success, "Transfer failed.");

    Received(_donor, msg.value, atomRate);
}
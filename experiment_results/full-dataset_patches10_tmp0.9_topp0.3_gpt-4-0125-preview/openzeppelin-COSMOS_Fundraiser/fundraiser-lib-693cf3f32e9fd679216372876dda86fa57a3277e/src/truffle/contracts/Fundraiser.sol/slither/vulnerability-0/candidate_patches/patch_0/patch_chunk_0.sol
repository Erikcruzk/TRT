function donate(address _donor, address _returnAddress, bytes32 checksum) payable only_during_period is_not_dust {
    
    if (!(sha3(bytes32(_donor)^bytes32(_returnAddress)) == checksum)) throw;

    var atoms = msg.value * atomRate;
    
    record[_donor] += atoms;
    returnAddresses[_donor] = _returnAddress;

    totalEther += msg.value;
    totalAtom += atoms;

    Received(_donor, msg.value, atomRate);

    // Move the treasury call to the end of the function to mitigate reentrancy
    if (!treasury.call.value(msg.value)()) throw;
}
function buyTokens(
    address _beneficiary
)
public
payable
onlyValidatedContracts
returns (uint)
{
    uint256 weiAmount = msg.value;
    _preValidatePurchase(_beneficiary, weiAmount);

    // Fix for vulnerability: Declare and initialize a new local variable instead of shadowing
    uint256 weiRaisedLocal = getUint("weiRaised").add(weiAmount);
    setUint("weiRaised", weiRaisedLocal);

    // Calculate the amount of tokens to be sold
    uint256 tokens = _getTokenAmountToBeSold(weiAmount);

    // Update the number of transactions
    setUint("transactionCounter", getUint("transactionCounter") + 1);

    // Process the purchase by transferring tokens to the beneficiary
    _processPurchase(_beneficiary, tokens);

    // Emit an event for the token purchase
    emit TokenPurchase(
        msg.sender,
        _beneficiary,
        weiAmount,
        tokens,
        getUint("sellRate2key")
    );

    return tokens;
}
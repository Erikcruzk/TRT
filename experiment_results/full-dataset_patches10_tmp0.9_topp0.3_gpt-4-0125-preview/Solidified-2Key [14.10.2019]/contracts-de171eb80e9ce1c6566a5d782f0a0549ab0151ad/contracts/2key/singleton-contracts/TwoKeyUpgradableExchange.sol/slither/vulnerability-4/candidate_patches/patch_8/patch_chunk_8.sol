function buyTokens(
    address _beneficiary
)
public
payable
onlyValidatedContracts
returns (uint)
{
    uint256 weiAmount = msg.value;
    _preValidatePurchase(_beneficiary, weiAmount);

    // Corrected shadowing by removing declaration of weiRaised
    // Now correctly updates the state variable instead of declaring a local variable    
    weiRaised = weiRaised.add(weiAmount);

    // Calculate tokens to be sold
    uint256 tokens = _getTokenAmountToBeSold(weiAmount);
    
    // Update transaction counter
    setUint("transactionCounter", getUint("transactionCounter")+1);

    _processPurchase(_beneficiary, tokens);


    emit TokenPurchase(
        msg.sender,
        _beneficiary,
        weiAmount,
        tokens,
        getUint("sellRate2key")
    );

    return tokens;
}